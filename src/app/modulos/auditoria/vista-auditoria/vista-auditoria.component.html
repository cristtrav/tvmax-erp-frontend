<div class="inner-component">
    <div class="main-breadcrumb">
        <nz-breadcrumb>
            <nz-breadcrumb-item>
                <a routerLink="/app/welcome"><i nz-icon nzType="home"></i></a>
            </nz-breadcrumb-item>
            <nz-breadcrumb-item>
                Auditoría
            </nz-breadcrumb-item>
        </nz-breadcrumb>
    </div>
    <div class="module-container">
        <div class="module-content">
            <div nz-row>
                <div nz-col nzFlex="auto">
                    <!--<a nz-button nzType="primary" routerLink="nuevo">
                        <i nz-icon nzType="plus"></i>
                        Nuevo
                    </a>-->
                </div>
                <div nz-col>
                    <nz-space>
                        <nz-input-group *nzSpaceItem [nzSuffix]="inputClearTpl" [nzPrefixIcon]="'search'">
                            <input nz-input placeholder="Buscar..." [(ngModel)]="textoBusqueda" (ngModelChange)="buscar()">
                            <ng-template #inputClearTpl>
                                <i
                                  nz-icon
                                  class="ant-input-clear-icon"
                                  nzTheme="fill"
                                  nzType="close-circle"
                                  *ngIf="textoBusqueda"
                                  (click)="limpiarBusqueda()"
                                ></i>
                              </ng-template>
                        </nz-input-group>
                        <nz-badge *nzSpaceItem [nzCount]="cantFiltrosAplicados">
                            <button nz-tooltip nz-button nzType="primary" nzTooltipTitle="Ver filtros" (click)="drawerFiltrosVisible = !drawerFiltrosVisible">
                                <i nz-icon nzType="filter" nzTheme="outline"></i>
                            </button>
                        </nz-badge>
                    </nz-space>
                </div>
            </div>

            <nz-drawer [nzContent]="contenidoFiltros" nzPlacement="right" nzTitle="Filtros" nzClosable="true" [nzVisible]="drawerFiltrosVisible" (nzOnClose)="drawerFiltrosVisible = false">
                <ng-template #contenidoFiltros>
                    <app-form-filtro-evento-auditoria (cantFiltrosChange)="cantFiltrosAplicados = $event" (paramsFiltrosChange)="paramsFiltros = $event"></app-form-filtro-evento-auditoria>
                </ng-template>
            </nz-drawer>

            <nz-table #tabla [nzTotal]="totalRegistros" [nzData]="lstEventos" [nzShowPagination]="true"
                [nzShowSizeChanger]="true" [nzFrontPagination]="true" [nzPageIndex]="pageIndex" [nzPageSize]="pageSize"
                [nzLoading]="tableLoading" [nzFooter]="footer" (nzQueryParams)="onTableQueryParamsChange($event)"
                nzSize="small" style="margin-top: 10px;">
                <thead>
                    <tr>
                        <th></th>
                        <th [nzColumnKey]="'id'" [nzSortFn]="true">Código</th>
                        <th [nzColumnKey]="'fechahora'" [nzSortFn]="true" nzSortOrder="descend">Fecha/Hora</th>
                        <th [nzColumnKey]="'nombresusuario'" [nzSortFn]="true">Usuario</th>
                        <th [nzColumnKey]="'operacion'" [nzSortFn]="true">Operación</th>
                        <th [nzColumnKey]="'tabla'" [nzSortFn]="true">Tabla</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let ea of tabla.data">
                        <tr>
                            <td [nzExpand]="expandSet.has(+(ea.id+''))"
                                (nzExpandChange)="onExpandChange(+(ea.id+''), $event)"></td>
                            <td>{{ ea.id }}</td>
                            <td>{{ ea.fechahora | date: 'dd/MM/yy HH:mm:ss' }}</td>
                            <td>
                                <span nz-tooltip [nzTooltipTitle]="'Código: '+ea.idusuario">
                                    {{ ea.nombresusuario }} {{ ea.apellidosusuario }}
                                </span>
                            </td>
                            <td>
                                <nz-tag nzColor="blue" *ngIf="ea.operacion === 'R'">
                                    <i nz-icon nzType="plus" nzTheme="outline"></i>
                                    Registro
                                </nz-tag>
                                <nz-tag nzColor="orange" *ngIf="ea.operacion === 'M'">
                                    <i nz-icon nzType="edit" nzTheme="outline"></i>
                                    Modificación
                                </nz-tag>
                                <nz-tag nzColor="red" *ngIf="ea.operacion === 'E'">
                                    <i nz-icon nzType="delete" nzTheme="outline"></i>
                                    Eliminación
                                </nz-tag>
                            </td>
                            <td>
                                {{ ea.tabla }}
                            </td>
                        </tr>
                        <tr [nzExpand]="expandSet.has(+(ea.id+''))">
                            <div nz-row nzGutter="16">
                                <div nz-col nzSpan="12">
                                    <h3>Estado anterior</h3>
                                    <nz-table #tablaestadoanterior
                                        [nzShowPagination]="false"
                                        [nzShowSizeChanger]="false"
                                        [nzData]="objectToKeyValue(ea.estadoanterior)"
                                        nzSize="small"
                                        nzBordered>
                                        <thead>
                                            <tr>
                                                <th>Campo</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let estadoa of tablaestadoanterior.data">
                                                <td>{{ estadoa.key }}</td>
                                                <td>{{ estadoa.value }}</td>
                                            </tr>
                                        </tbody>
                                    </nz-table>
                                </div>
                                <div nz-col nzSpan="12">
                                    <h3>Estado nuevo</h3>
                                    <nz-table #tablaestadonuevo
                                        [nzShowPagination]="false"
                                        [nzShowSizeChanger]="false"
                                        [nzData]="objectToKeyValue(ea.estadonuevo)"
                                        nzSize="small"
                                        nzBordered>
                                        <thead>
                                            <tr>
                                                <th>Campo</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let estadoa of tablaestadonuevo.data">
                                                <td>{{ estadoa.key }}</td>
                                                <td>{{ estadoa.value }}</td>
                                            </tr>
                                        </tbody>
                                    </nz-table>
                                </div>
                            </div>
                        </tr>
                    </ng-container>
                </tbody>
                <ng-template #footer>
                    <strong>Total:</strong> {{ totalRegistros }}
                </ng-template>
            </nz-table>
        </div>
    </div>
</div>